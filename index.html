<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Swiss Planner</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css?family=PT+Sans" rel="stylesheet">
  </head>
  <body>
    <form autocomplete="off">
      <table>
        <tr>
          <th><span class="header">From</span></th>
          <th><span class="header">To</span></th>
          <th><span class="header">Date</span></th>
          <th><span class="header">Time</span></th>
        </tr>
        <tr>
          <td><input id="from" size="30"></input></td>
          <td><input id="to" size="30"></input></td>
          <td><input type="date" id="date"></input></td>
          <td><input type="time" id="time"></input></td>
        </tr>
        <tr><td class="fromOption"></td><td class="toOption"></td></tr>
        <tr><td class="fromOption"></td><td class="toOption"></td></tr>
        <tr><td class="fromOption"></td><td class="toOption"></td></tr>
        <tr><td class="fromOption"></td><td class="toOption"></td></tr>
        <tr><td class="fromOption"></td><td class="toOption"></td></tr>
        <tr><td class="fromOption"></td><td class="toOption"></td></tr>
        <tr><td class="fromOption"></td><td class="toOption"></td></tr>
        <tr><td class="fromOption"></td><td class="toOption"></td></tr>
        <tr><td class="fromOption"></td><td class="toOption"></td></tr>
        <tr><td class="fromOption"></td><td class="toOption"></td></tr>
      </table>
    </form>
  </body>
  <script>
    var fromCount = 0;
    var toCount = 0;
    var from = document.querySelector('#from');
    var to = document.querySelector('#to');
    var fromOptionList = document.querySelectorAll('td.fromOption');
    var toOptionList = document.querySelectorAll('td.toOption');
    var iconList = ["sl-icon-type-bus", "sl-icon-type-fun", "sl-icon-type-sb", "sl-icon-type-ship", "sl-icon-type-tram", "sl-icon-type-zug", "sl-icon-type-gondola", "sl-icon-type-chairlift", "sl-icon-type-train", "sl-icon-type-post", "sl-icon-type-night-bus", "sl-icon-type-strain", "sl-icon-type-night-strain", "sl-icon-type-express-train"];
    var date = document.querySelector('#date')
    var time = document.querySelector('#time')
    
    var currentTime = new Date();
    date.valueAsDate = currentTime;
    time.value = currentTime.getHours() + ":" + currentTime.getMinutes();
    
    from.addEventListener('input', function() {
      fromCount++;
      httpGet('https://timetable.search.ch/api/completion.json?term=' + from.value, 'from', locationsCallback, fromCount);
    });
    to.addEventListener('input', function() {
      toCount++;
      httpGet('https://timetable.search.ch/api/completion.json?term=' + to.value, 'to', locationsCallback, toCount);
    });
    
    fromOptionList.forEach(function(fromOption) {
      fromOption.addEventListener('click', function() {
        if (fromOption.innerHTML === "") {
          return;
        }
        from.value = fromOption.value;
        for (option of fromOptionList) {
          option.style.backgroundColor = "white";
        }
        fromOption.style.backgroundColor = "#eee";
      });
    });
    toOptionList.forEach(function(toOption) {
      toOption.addEventListener('click', function() {
        if (toOption.innerHTML === "") {
          return;
        }
        to.value = toOption.value;
        for (option of toOptionList) {
          option.style.backgroundColor = "white";
        }
        toOption.style.backgroundColor = "#eee";
      });
    });
    
    function locationsCallback(json, type, callCount) {
      var stationList = []
      for (station of json) {
        if (iconList.includes(station.iconclass)) {
          stationList.push(station);
        }
      }
      if (type === 'from') {
        if (fromCount != callCount) {
          return;
        }
        for (fromOption of fromOptionList) {
          fromOption.value = "";
          fromOption.innerHTML = "";
          fromOption.style.backgroundColor = "white";
        }
        for (var i = 0; i < stationList.length; i++) {
          fromOptionList[i].value = stationList[i].label;
          fromOptionList[i].innerHTML = stationList[i].html ? stationList[i].html : stationList[i].label;
        }
      } else {
        if (toCount != callCount) {
          return;
        }
        for (toOption of toOptionList) {
          toOption.value = "";
          toOption.innerHTML = "";
          toOption.style.backgroundColor = "white";
        }
        for (var i = 0; i < stationList.length; i++) {
          toOptionList[i].value = stationList[i].label;
          toOptionList[i].innerHTML = stationList[i].html ? stationList[i].html : stationList[i].label;
        }
      }
    }
    
    function httpGet(url, type, callback, callCount) {
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.onreadystatechange = function() { 
        if (xmlHttp.readyState === XMLHttpRequest.DONE && xmlHttp.status === 200) {
          callback(JSON.parse(xmlHttp.responseText), type, callCount);
        }
      }
      xmlHttp.open("GET", url, true);
      xmlHttp.send(null);
    }
  </script>
</html>
